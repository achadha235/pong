<html>
	<head>
		<link href="style/style.css" rel="stylesheet" type="text/css">
		<script src="js/socket.io.js"> </script>
	</head>
	<body>
		<div id='status'> </div>
		<div id = 'screen'>
		<canvas id="myCanvas" width="400" height="400"></canvas>
		<div id = 'controller'>
			<img id ='leftButton' src = 'style/leftButton.png'></img>
			<img id ='rightButton' src = 'style/rightButton.png'></img>
		</div>
	</div>
	</body>
</html>


<script>

	var data ;
	var socket = io.connect('http://localhost:3000');
	var canvas = document.getElementById('myCanvas');
	var ctx = canvas.getContext("2d");
	var myPlayer;

	var ball = new Image();
	ball.src = 'style/spriteSheet.png';

	var paddle1 = new Image();
	paddle1.src = 'style/Paddle1.png';
	
	var paddle2 = new Image();
	paddle2.src = 'style/Paddle2.png';
	
	var paddle3 = new Image();
	paddle3.src = 'style/Paddle3.png';
	
	var paddle4 = new Image();
	paddle4.src = 'style/Paddle4.png';

	var corners = new Image();
	corners.src = 'style/Corners.png'


	var params = {
		height: 400,
		width: 400,
		radius: 5,
		border: 50,
		paddleHeight: 15,
		paddleWidth: 84,
		colors: ["#F0F000","#00F0F0","#F000F0","#00FF00"],
		paddles: [paddle1, paddle2, paddle3, paddle4],
		ball: {x:200, y:200}
	}


	socket.on('update', function (model){
		data = model;
		console.log('updating model...');
		updateTable();
		drawAll();
	})
	socket.on('setPlayerNumber', function (assignment){
		myPlayer = assignment.yourPlayerNumber
		console.log('addEventListener');
		window.addEventListener('keydown', function (e){
			if (e.keyCode === 83) {
				socket.emit('start_game',{});
				console.log('start_game');
			}
		});
	})

	var leftPressed = false;
	var rightPressed = false;

	window.addEventListener('keydown', function (e) {
    	if (e.keyCode === 37 && !leftPressed && !rightPressed) {
    		leftPressed = true;
	        socket.emit('moveLeft', {});
	    }
	    else if (e.keyCode === 39  && !leftPressed && !rightPressed){
	    	rightPressed = true;
	    	socket.emit('moveRight', {});
	    }
	}, false);

	window.addEventListener('keyup', function (e) {
    	if (e.keyCode === 37) {
    		leftPressed = false;
	        socket.emit('stop', {});
	    }
	    else if (e.keyCode === 39){
	    	rightPressed = false;
	    	socket.emit('stop', {});
	    }
	}, false);

	function updateTable(){
		console.log(data);
		document.getElementById('status').innerHTML = JSON.stringify(data);
	}


	function drawAll() {
		//console.log('drawAll');
		drawBackground();
		drawPaddles();
		relBallPos();
		drawBall();
	}

	function drawBackground(){
		ctx.fillStyle="#3a3a3a";
		ctx.fillRect(0, 0, canvas.width, canvas.height);
		ctx.fillStyle="#1f1f1f";
		ctx.fillRect(0, 0, canvas.width, 7);
		ctx.fillStyle="#4b4b4b";
		ctx.fillRect(0, canvas.height-6, canvas.width, 7);
		ctx.fillStyle="#2c2c2c";
		ctx.fillRect(0, 0, 7, canvas.height);
		ctx.fillRect(canvas.width-6, 0, 7, canvas.height);
		ctx.fillStyle="#111111";
		ctx.fillRect(7, 7, canvas.width-14, canvas.height-14);
		ctx.drawImage(corners, 0, 0, 22, 22, 0, 0, 22, 22);
		ctx.drawImage(corners, 23, 0, 22, 22, canvas.width-21, 0, 22, 22);
		ctx.drawImage(corners, 0, 23, 22, 22, 0, canvas.height-21, 22, 22);
		ctx.drawImage(corners, 23, 23, 22, 22, canvas.width-21, canvas.height-21, 22, 22);
	}

	function drawPaddles(){//p1_x p1_y ...
		//Paddle 0
		ctx.drawImage(params.paddles[myPlayer], 0, 84, 84, 15, data.positions[myPlayer], params.height-params.paddleHeight, 84, 15);

		//Paddle 1
		ctx.drawImage(params.paddles[(myPlayer+1)%4], 0, 0, 15, 84, params.width-params.paddleHeight, params.height-params.paddleWidth-data.positions[(myPlayer+1)%4], 15, 84);

		//Paddle 2
		ctx.drawImage(params.paddles[(myPlayer+2)%4], 0, 99, 84, 15, params.width-params.paddleWidth-data.positions[(myPlayer+2)%4], 0, 84, 15);

		//Paddle 3
		ctx.drawImage(params.paddles[(myPlayer+3)%4], 15, 0, 15, 84, 0, data.positions[(myPlayer+3)%4], 15, 84);
	}

	function drawBall(){//data.ball.x, data.ball.y....
	ctx.drawImage(ball, 6, 6, 17, 17, params.ball.x, params.ball.y, 17, 17);
	}

	function relBallPos(){
		switch(myPlayer){
			case 0:
				params.ball.x = data.ball.x;
				params.ball.y = data.ball.y;
				break;
			case 1:
				params.ball.x = params.height-data.ball.y;
				params.ball.y = data.ball.x;
				break;
			case 2:
				params.ball.x = params.width-data.ball.x;
				params.ball.y = params.height-data.ball.y;
				break;
			case 3:
				params.ball.x = data.ball.y;
				params.ball.y = params.width-data.ball.x;
				break;
		}
	}

</script>
