<html>
	<head>
		<script src="js/socket.io.js"> </script>
		<meta name="viewport" content="width=device-width, initial-scale=1.5, maximum-scale=1.5, user-scalable=no" />
	</head>

	<body>
		<div id='status'> </div>
		<canvas id="myCanvas" width="400" height="400"></canvas>
		<div id='buttons'>
			<button id='leftButton' class='button'> L </button>
			<button id='rightButton' class='button'> R </button>
		</div>
	</body>
</html>

<style>
	body {
		overflow: hidden;
	}
	#buttons{
		width: 400px;
		height: 300px;
	}

	.button {
		margin-left: 3%;
		margin-top: 5px;
		float:left;
		height:180px;
		width: 180px;
		background-color: black;
		color: white;
	}
</style>


<script>

	var socket = io.connect('http://192.168.8.107:3000');
	var canvas = document.getElementById('myCanvas');
	var ctx = canvas.getContext("2d");
	var myPlayer;


	var data = {
	positions: [150, 150, 150, 150],
	actions: [0, 0, 0, 0],
	ball: {x: 200, y: 200, dx: 1, dy: 4}
	}


	var params = {
		height: 400,
		width: 400,
		radius: 5,
		border: 50,
		paddleHeight: 10,
		paddleWidth: 100,
		colors: ["#F0F000","#00F0F0","#F000F0","#00FF00"],
		ball: {x:200, y:200}
	}


	socket.on('update', function (model){
		data = model;
		//console.log('updating model...');
		updateTable();
		drawAll();
	})
	socket.on('setPlayerNumber', function (assignment){
		myPlayer = assignment.yourPlayerNumber
		drawAll();                                                                                                                                               
		//console.log('addEventListener');
		window.addEventListener('keydown', function (e){
			if (e.keyCode === 83) {
				socket.emit('start_game',{});
				//console.log('start_game');
			}
		});

		window.addEventListener('keydown', function (e){
			if (e.keyCode === 83) {
				socket.emit('start_game',{});
				//console.log('start_game');
			}
		});


	})

	var leftPressed = false;
	var rightPressed = false;

	window.addEventListener('keydown', function (e) {
    	if (e.keyCode === 37 && !leftPressed && !rightPressed) {
    		leftPressed = true;
	        socket.emit('moveLeft', {});
	    }
	    else if (e.keyCode === 39  && !leftPressed && !rightPressed){
	    	rightPressed = true;
	    	socket.emit('moveRight', {});
	    }
	}, false);

	window.addEventListener('keyup', function (e) {
    	if (e.keyCode === 37) {
    		leftPressed = false;
	        socket.emit('stop', {});
	    }
	    else if (e.keyCode === 39){
	    	rightPressed = false;
	    	socket.emit('stop', {});
	    }
	}, false);

	var elements = document.getElementsByClassName('button')
	for (var i = 0; i < elements.length; i++){

		var element = elements[i];
		element.addEventListener('touchend', function (e) {
	    	if (e.target.id === "leftButton") {
	    		leftPressed = false;
		        socket.emit('stop', {});
		    }
		    else if (e.target.id === "rightButton"){
		    		  console.log('r STop')

		    	rightPressed = false;
		    	socket.emit('stop', {});
		    }
		}, false);

		element.addEventListener('touchstart', function (e) {
	    	if (e.target.id === "leftButton" && !leftPressed && !rightPressed) {
	    		console.log('LEFT START')
	    		leftPressed = true;
		        socket.emit('moveLeft', {});
		    }
		    else if (e.target.id === "rightButton" && !leftPressed && !rightPressed){
		    		    		console.log('r START')

		    	rightPressed = true;
		    	socket.emit('moveRight', {});
		    }
		}, false);
	}

	document.getElementById("myCanvas").addEventListener('touchstart', function (e){
		console.log('Starting game....')
		socket.emit('start_game',{});
	})

	function updateTable(){
		//console.log(data);
		document.getElementById('status').innerHTML = JSON.stringify(data);
	}

	function drawAll() {
		//console.log('drawAll');
		drawBackground();
		drawPaddles();
		relBallPos();
		drawBall();
	}

	function drawBackground(){
		ctx.fillStyle="#000000";
		ctx.fillRect(0, 0, 400, 400);
	}

	function drawPaddles(){//p1_x p1_y ...
		//Paddle 0
		//console.log('Drawing paddles')
		ctx.fillStyle=params.colors[myPlayer];
		ctx.fillRect(data.positions[myPlayer], params.height-params.paddleHeight, params.paddleWidth, params.paddleHeight);

		//Paddle 1
		ctx.fillStyle=params.colors[(myPlayer+1)%4];
		ctx.fillRect(params.width-params.paddleHeight, params.height-params.paddleWidth-data.positions[(myPlayer+1)%4], params.paddleHeight, params.paddleWidth);

		//Paddle 2
		ctx.fillStyle= params.colors[(myPlayer+2)%4];
		ctx.fillRect(params.width-params.paddleWidth-data.positions[(myPlayer+2)%4], 0, params.paddleWidth, params.paddleHeight);

		//Paddle 3
		ctx.fillStyle=params.colors[(myPlayer+3)%4];
		ctx.fillRect(0, data.positions[(myPlayer+3)%4], params.paddleHeight, params.paddleWidth);
	}

	function drawBall(){//data.ball.x, data.ball.y....
		ctx.beginPath();
		ctx.arc(Math.round(params.ball.x), Math.round(params.ball.y), params.radius, 0, Math.PI*2, true); 
		ctx.closePath();
		ctx.fillStyle = 'white';
		ctx.fill();
	}

	function relBallPos(){
		switch(myPlayer){
			case 0:
				params.ball.x = data.ball.x;
				params.ball.y = data.ball.y;
				break;
			case 1:
				params.ball.x = params.height-data.ball.y;
				params.ball.y = data.ball.x;
				break;
			case 2:
				params.ball.x = params.width-data.ball.x;
				params.ball.y = params.height-data.ball.y;
				break;
			case 3:
				params.ball.x = data.ball.y;
				params.ball.y = params.width-data.ball.x;
				break;
		}
	}

</script>
